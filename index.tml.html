<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethiopia MoH | Marburg Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #8b0000; /* Deep Maroon/Red */
            --color-secondary: #ff4500; /* Orange-Red */
            --color-background: #0d1117; /* Dark Grey/Blue */
            --color-text: #e5e7eb; /* Light Gray */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            scroll-behavior: smooth;
        }
        .gradient-bg-hero {
            background: linear-gradient(135deg, #1f1f3a, #0d1117);
        }
        .gradient-card-high {
            background: linear-gradient(145deg, #440000, #8b0000);
            box-shadow: 0 10px 30px rgba(139, 0, 0, 0.4);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .gradient-card-high:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(255, 69, 0, 0.6);
        }
        .gradient-card-mid {
            background: linear-gradient(145deg, #3a2e00, #966900);
            box-shadow: 0 10px 30px rgba(150, 105, 0, 0.3);
        }
        .gradient-section {
            background: radial-gradient(circle at top right, rgba(139, 0, 0, 0.2), transparent 50%);
        }
        .report-header-bg {
             background: linear-gradient(90deg, #8b0000, #440000);
        }
        .icon-container {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
        }
        .nav-link:hover {
            color: var(--color-secondary);
            border-bottom: 2px solid var(--color-secondary);
        }
        .data-point {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
        }
        /* Custom styles for the Canvas chart */
        #caseTrendChart {
            background-color: #1f2937; /* Darker background for chart readability */
            border-radius: 8px;
        }
    </style>
</head>
<body class="selection:bg-red-900 selection:text-white">

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 bg-gray-900/90 backdrop-blur-sm shadow-xl">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo/Title -->
                <div class="flex-shrink-0 text-2xl font-extrabold tracking-tight text-white">
                    <span class="text-red-600">MOH</span> <span class="text-yellow-500">Marburg</span> Watch
                </div>
                <!-- Nav Links -->
                <div class="flex space-x-8">
                    <a href="#about" class="nav-link text-sm font-medium text-gray-300 py-1 transition duration-150">About Marburg</a>
                    <a href="#dashboard" class="nav-link text-sm font-medium text-gray-300 py-1 transition duration-150">Dashboard</a>
                    <a href="#trends" class="nav-link text-sm font-medium text-gray-300 py-1 transition duration-150">Trends</a>
                    <a href="#report" class="nav-link text-sm font-medium text-gray-300 py-1 transition duration-150">Report</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="min-h-screen">
        <!-- Hero Section -->
        <header id="hero" class="gradient-bg-hero pt-20 pb-20 sm:pt-32 sm:pb-32">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-4xl sm:text-6xl font-extrabold tracking-tighter text-white">
                    <span class="block text-gray-300">Ethiopia Ministry of Health</span>
                    <span class="block mt-2 text-red-600">Marburg Virus Outbreak Monitoring</span>
                </h1>
                <p class="mt-4 text-xl text-gray-400 max-w-3xl mx-auto">
                    Real-time data consolidation and situation assessment for national public health response.
                </p>
                <p class="mt-6 text-sm font-medium text-yellow-500" id="last-updated-display">
                    Last Verified Data: Loading...
                </p>
            </div>
        </header>

        <!-- About Marburg Section -->
        <section id="about" class="py-16 gradient-section border-t border-gray-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl font-bold text-red-500 mb-8 border-b border-red-800/50 pb-2">About Marburg Virus Disease (MVD)</h2>
                
                <div class="grid md:grid-cols-2 gap-12 items-start">
                    <!-- Text Content -->
                    <div>
                        <div class="space-y-6 text-gray-300 text-lg">
                            <p>
                                Marburg Virus Disease (MVD) is a severe, often fatal, illness in humans. It is caused by the Marburg virus, a filovirus genetically related to the virus that causes Ebola. The case fatality rate can be as high as 88%.
                            </p>
                            <p>
                                MVD is transmitted to people from fruit bats and spreads among humans through direct contact with the blood, secretions, organs, or other body fluids of infected people, and from surfaces and materials (e.g., bedding, clothing) contaminated with these fluids.
                            </p>
                            
                            <h3 class="text-xl font-semibold text-white mt-6">Key Symptoms:</h3>
                            <ul class="list-disc list-inside space-y-2 ml-4">
                                <li>High fever, severe headache, and malaise.</li>
                                <li>Severe watery diarrhea, abdominal pain, nausea, and vomiting.</li>
                                <li>Many patients develop severe hemorrhagic manifestations (bleeding).</li>
                            </ul>
                            <p class="text-sm italic text-gray-400 pt-4">Early identification and rigorous isolation are critical for halting transmission.</p>
                        </div>
                    </div>

                    <!-- Images Container (Right Column) -->
                    <div class="space-y-6">
                        <h4 class="text-2xl font-semibold text-red-400">Visual Aids</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">

                            <!-- Image 1: Virus Structure -->
                            <div class="rounded-xl overflow-hidden shadow-2xl border border-red-700/50 bg-gray-900 p-4">
                                <h5 class="text-lg font-semibold text-yellow-400 mb-2">Virus Structure (EM)</h5>
                                <div class="h-48 flex items-center justify-center bg-gray-800 rounded-lg">
                                    <img src="image_a1135d.jpg" alt="Electron micrograph of the Marburg virus structure" class="max-h-full w-auto object-contain rounded-lg border border-red-800/50">
                                </div>
                                <p class="text-center text-xs italic text-gray-400 mt-2">
                                    Filamentous structure of the Marburg virus.
                                </p>
                            </div>

                            <!-- Image 2: Transmission Cycle (Placeholder) -->
                            <div class="rounded-xl overflow-hidden shadow-2xl border border-red-700/50 bg-gray-900 p-4">
                                <h5 class="text-lg font-semibold text-yellow-400 mb-2">Transmission Cycle</h5>
                                <div class="h-48 flex items-center justify-center bg-gray-800 rounded-lg">
                                    <!-- Using the same uploaded image for the placeholder -->
                                    <img src="image_a1135d.jpg" alt="Diagram illustrating the Marburg transmission cycle" class="max-h-full w-auto object-contain rounded-lg border border-red-800/50">
                                </div>
                                <p class="text-center text-xs italic text-gray-400 mt-2">
                                    Diagram of the natural reservoir (bats) and human-to-human transmission (MOH Placeholder).
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard" class="py-16 bg-gray-900 border-t border-gray-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl font-bold text-red-500 mb-10 border-b border-red-800/50 pb-2">Outbreak Dashboard & Key Metrics</h2>
                
                <!-- Risk Level Alert Bar -->
                <div id="risk-level-alert" class="p-6 rounded-xl shadow-2xl mb-12 text-center transition-all duration-500">
                    <p class="text-2xl font-extrabold uppercase flex items-center justify-center">
                        <span class="mr-3 text-3xl">üö®</span> NATIONAL RISK LEVEL: <span id="risk-level-value" class="ml-4 text-4xl font-black">HIGH</span>
                    </p>
                </div>

                <!-- Metrics Grid -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
                    
                    <!-- Confirmed Cases -->
                    <div class="p-5 rounded-xl gradient-card-high border-2 border-red-700">
                        <div class="icon-container mb-3 bg-red-800">ü¶†</div>
                        <p class="text-sm uppercase font-semibold text-gray-300">Confirmed Cases</p>
                        <p class="data-point text-red-300" id="metric-cases">--</p>
                    </div>

                    <!-- Deaths -->
                    <div class="p-5 rounded-xl gradient-card-high border-2 border-red-700">
                        <div class="icon-container mb-3 bg-red-900">‚ö∞Ô∏è</div>
                        <p class="text-sm uppercase font-semibold text-gray-300">Confirmed Deaths</p>
                        <p class="data-point text-red-400" id="metric-deaths">--</p>
                    </div>
                    
                    <!-- Case Fatality Rate (CFR) -->
                    <div class="p-5 rounded-xl gradient-card-high border-2 border-red-700">
                        <div class="icon-container mb-3 bg-red-700">üìà</div>
                        <p class="text-sm uppercase font-semibold text-gray-300">Case Fatality Rate</p>
                        <p class="data-point text-yellow-400" id="metric-cfr">--%</p>
                    </div>

                    <!-- Suspected Cases -->
                    <div class="p-5 rounded-xl gradient-card-mid border-2 border-yellow-700">
                        <div class="icon-container mb-3 bg-yellow-800">‚ö†Ô∏è</div>
                        <p class="text-sm uppercase font-semibold text-gray-300">Suspected Cases</p>
                        <p class="data-point text-yellow-300" id="metric-suspected">--</p>
                    </div>

                    <!-- Contacts Monitored -->
                    <div class="p-5 rounded-xl gradient-card-mid border-2 border-yellow-700">
                        <div class="icon-container mb-3 bg-yellow-900">üë•</div>
                        <p class="text-sm uppercase font-semibold text-gray-300">Contacts Monitored</p>
                        <p class="data-point text-yellow-300" id="metric-contacts">--</p>
                    </div>

                    <!-- Tests Conducted -->
                    <div class="p-5 rounded-xl bg-gray-800/70 border border-gray-700">
                        <div class="icon-container mb-3 bg-blue-800">üß™</div>
                        <p class="text-sm uppercase font-semibold text-gray-300">Tests Conducted</p>
                        <p class="text-2xl font-bold text-blue-300" id="metric-tests">--</p>
                    </div>
                    
                    <!-- Test Positivity Rate -->
                    <div class="p-5 rounded-xl bg-gray-800/70 border border-gray-700">
                        <div class="icon-container mb-3 bg-blue-700">üìä</div>
                        <p class="text-sm uppercase font-semibold text-gray-300">Test Positivity Rate</p>
                        <p class="text-2xl font-bold text-blue-300" id="metric-tpr">--%</p>
                    </div>
                    
                    <!-- Data Sources -->
                    <div class="col-span-2 md:col-span-3 p-5 rounded-xl bg-gray-800/70 border border-gray-700">
                        <div class="flex items-center">
                            <div class="icon-container mr-3 bg-green-800">üóÑÔ∏è</div>
                            <p class="text-sm uppercase font-semibold text-gray-300">Data Sources Used</p>
                        </div>
                        <p class="mt-2 text-base font-medium text-green-300" id="metric-sources">Loading...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- TRENDS & FORECASTING SECTION (NEW) -->
        <section id="trends" class="py-16 bg-gray-900 border-t border-gray-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl font-bold text-yellow-500 mb-10 border-b border-yellow-800/50 pb-2">Epidemiological Trends & Next Week Forecast</h2>
                
                <div class="grid lg:grid-cols-3 gap-8">
                    <!-- Chart Area -->
                    <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-inner border border-red-900/50">
                        <h3 class="text-xl font-semibold text-white mb-4">Confirmed Cases Trend (Last 14 Days + 7 Day Forecast)</h3>
                        <canvas id="caseTrendChart" class="w-full h-96"></canvas>
                    </div>
                    
                    <!-- Forecast Summary -->
                    <div class="lg:col-span-1 bg-gray-800/70 p-6 rounded-xl shadow-lg border border-yellow-700/50 space-y-4">
                        <h3 class="text-2xl font-semibold text-yellow-300 border-b border-yellow-700 pb-2">7-Day Projection (Model: SEIR)</h3>
                        <div class="text-gray-300">
                            <p class="text-sm uppercase font-bold text-red-400">Predicted Total Cases (Week End)</p>
                            <p class="text-4xl font-extrabold text-red-300" id="forecast-cases">--</p>
                        </div>
                        <div class="text-gray-300 pt-2">
                            <p class="text-sm uppercase font-bold text-red-400">Predicted Peak Day</p>
                            <p class="text-2xl font-bold text-yellow-300" id="forecast-peak">--</p>
                        </div>
                        <p id="forecast-narrative" class="text-sm italic text-gray-400 mt-4">
                            Loading predictive model summary...
                        </p>
                        <p class="text-xs text-gray-500 pt-4 border-t border-gray-700">
                            Note: Forecasting models are highly dependent on mitigation strategies and data accuracy. This is a preliminary projection.
                        </p>
                    </div>
                </div>
            </div>
        </section>
        <!-- END TRENDS & FORECASTING SECTION -->


        <!-- Situation Report Section -->
        <section id="report" class="py-16 gradient-section border-t border-gray-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl font-bold text-red-500 mb-10 border-b border-red-800/50 pb-2">Official Situation Report (SITREP)</h2>
                
                <div class="bg-gray-900 rounded-xl shadow-3xl overflow-hidden border border-red-900">
                    <!-- Report Header -->
                    <div class="report-header-bg p-6">
                        <h3 class="text-xl sm:text-3xl font-bold text-white tracking-wide">MARBURG VIRUS OUTBREAK - ETHIOPIA</h3>
                        <p class="text-sm text-gray-200 mt-1">Generated: <span id="report-generated-at">Loading...</span></p>
                    </div>

                    <!-- Report Body: Executive Summary -->
                    <div class="p-6 md:p-8 space-y-6">
                        <h4 class="text-2xl font-semibold text-red-400">Executive Summary</h4>
                        <pre id="report-summary" class="text-gray-300 whitespace-pre-wrap leading-relaxed bg-gray-800/50 p-4 rounded-lg overflow-x-auto text-sm">Loading Situation Report Summary...</pre>
                        
                        <!-- Recommendations -->
                        <h4 class="text-2xl font-semibold text-yellow-400 pt-4">Immediate Recommendations</h4>
                        <ul id="report-recommendations" class="space-y-3 list-disc list-inside text-gray-300 ml-4">
                            <!-- Recommendations will be populated here -->
                            <li class="text-sm text-gray-400">Loading recommendations...</li>
                        </ul>

                        <!-- Data Quality Notes -->
                        <h4 class="text-xl font-semibold text-gray-400 pt-6 border-t border-gray-700/50">Data Quality & Coordination</h4>
                        <div class="text-sm text-gray-400 italic space-y-1">
                            <p>‚Äî Note: Case and death reports show minor variance across international sources (WHO, CDC, UKHSA). Conservative estimates are utilized for official planning.</p>
                            <p>‚Äî Ongoing reconciliation and validation are performed daily by EPHI and MoH surveillance teams.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>
    
    <!-- Footer -->
    <footer class="mt-16 py-8 bg-gray-900 border-t border-red-900/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
            &copy; 2025 Ethiopia Ministry of Health. All rights reserved. | <span class="text-red-600">Public Health Emergency Monitoring System.</span>
        </div>
    </footer>


    <script>
        // --- DATA SIMULATION LOGIC ---

        // Helper function to get dates
        function getDateNDaysAgo(n) {
            const d = new Date();
            d.setDate(d.getDate() - n);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        // Helper function to get future dates
        function getDateNDaysFromNow(n) {
            const d = new Date();
            d.setDate(d.getDate() + n);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }


        /**
         * Simulates fetching data from various health organizations and generates time series.
         */
        function generateRawData() {
            const now = new Date();
            const lastReportDate = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString();
            const updateDate = new Date(now.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            // 1. Static Metrics
            const ephi_data = { "source": "Ethiopian Public Health Institute (EPHI)", "timestamp": now.toISOString(), "outbreaks": [{ "cases": 6, "deaths": 6, "suspected_cases": 73, "contacts_under_followup": 349, "last_report_date": lastReportDate }] };
            const who_data = { "source": "World Health Organization (WHO)", "global_alerts": [{ "confirmed_cases": 6, "confirmed_deaths": 3, "contacts_monitored": 206, "report_date": updateDate }] };
            const cdc_data = { "source": "US Centers for Disease Control (CDC)", "outbreak_assessments": [{ "total_cases": 12, "total_deaths": 7, "report_date": updateDate }] };
            const ukhsa_data = { "source": "UK Health Security Agency (UKHSA)", "assessments": [{ "confirmed_cases": 10, "confirmed_deaths": 5, "assessment_date": updateDate }] };
            const lab_data = { "source": "National Laboratory Network", "tests_conducted": 150, "positive_cases": 8 };

            // 2. Time Series Data (14 days historical)
            // Simulating a slightly rising then stabilizing case count (Cumulative Cases)
            const historicalCases = [2, 2, 3, 3, 4, 5, 5, 6, 7, 8, 9, 10, 11, 12]; // 14 days
            const labels = [];
            for (let i = 13; i >= 0; i--) {
                labels.push(getDateNDaysAgo(i));
            }

            const timeSeries = {
                labels: labels,
                cases: historicalCases
            };
            
            return { ephi_data, who_data, cdc_data, ukhsa_data, lab_data, timeSeries };
        }

        /**
         * Simple simulation of SEIR-like forecasting for the next 7 days.
         * Based on the last day's confirmed cases.
         */
        function predictForecast(historicalCases) {
            const lastCaseCount = historicalCases[historicalCases.length - 1];
            const forecast = [];
            let current = lastCaseCount;
            let peakDay = null;

            // Simple model: high growth (Day 1-3), slowing growth (Day 4-5), stabilization (Day 6-7)
            const growthRates = [1.2, 1.15, 1.1, 1.05, 1.02, 1.01, 1.01];
            
            for (let i = 0; i < 7; i++) {
                current = Math.round(current * growthRates[i]);
                forecast.push(current);
                if (peakDay === null && current > lastCaseCount) {
                    peakDay = getDateNDaysFromNow(i + 1);
                }
            }

            const totalForecastCases = forecast[forecast.length - 1];
            const peakCaseCount = Math.max(...forecast);
            
            const narrative = `The SEIR-based model projects a steady increase in cumulative cases over the next week, reaching a projected total of ${totalForecastCases}. The growth rate is expected to peak around ${peakDay}, indicating a potential stabilization or a decrease in new daily cases thereafter, provided current interventions are maintained.`;

            return {
                forecast: forecast,
                total_forecast_cases: totalForecastCases,
                peak_day: peakDay || 'Week 1 End',
                narrative: narrative,
            };
        }

        /**
         * Simulates the Python's verify_data function to consolidate metrics.
         * Updated to include time series and forecast data.
         */
        function verifyData(rawData) {
            const { ephi_data, who_data, cdc_data, ukhsa_data, lab_data, timeSeries } = rawData;

            // Extract static case/death data (using highest for confirmed count)
            const sourceCases = { "MOH": ephi_data.outbreaks[0].cases || 0, "WHO": who_data.global_alerts[0].confirmed_cases || 0, "CDC": cdc_data.outbreak_assessments[0].total_cases || 0, "UKHSA": ukhsa_data.assessments[0].confirmed_cases || 0 };
            const sourceDeaths = { "MOH": ephi_data.outbreaks[0].deaths || 0, "WHO": who_data.global_alerts[0].confirmed_deaths || 0, "CDC": cdc_data.outbreak_assessments[0].total_deaths || 0, "UKHSA": ukhsa_data.assessments[0].confirmed_deaths || 0 };
            
            const caseValues = Object.values(sourceCases);
            const deathValues = Object.values(sourceDeaths);

            const confirmedCases = Math.max(...caseValues);
            const deaths = Math.max(...deathValues);

            // Calculate static metrics
            const caseFatalityRate = confirmedCases > 0 ? ((deaths / confirmedCases) * 100).toFixed(1) : 0;
            const testPositivityRate = lab_data.tests_conducted > 0 ? ((lab_data.positive_cases / lab_data.tests_conducted) * 100).toFixed(1) : 0;
            const contactsMonitored = Math.max(ephi_data.outbreaks[0].contacts_under_followup || 0, who_data.global_alerts[0].contacts_monitored || 0);
            const riskLevel = assessRiskLevel(confirmedCases, parseFloat(caseFatalityRate));

            // Generate Forecast
            const forecastData = predictForecast(timeSeries.cases);

            return {
                timestamp: new Date().toISOString(),
                confirmed_cases: confirmedCases,
                deaths: deaths,
                suspected_cases: ephi_data.outbreaks[0].suspected_cases,
                tests_conducted: lab_data.tests_conducted,
                positive_cases: lab_data.positive_cases,
                case_fatality_rate: caseFatalityRate,
                test_positivity_rate: testPositivityRate,
                contacts_monitored: contactsMonitored,
                risk_level: riskLevel,
                data_sources: ["EPHI", "WHO", "CDC", "UKHSA", "National Laboratory Network"],
                data_discrepancies: {
                    case_range: `${Math.min(...caseValues)}-${Math.max(...caseValues)}`,
                    death_range: `${Math.min(...deathValues)}-${Math.max(...deathValues)}`,
                },
                source_details: sourceCases,
                // Time Series and Forecast Data
                time_series: timeSeries,
                forecast_data: forecastData
            };
        }
        
        function assessRiskLevel(cases, fatalityRate) {
            if (cases === 0) return "Low";
            if (cases <= 5) return fatalityRate < 50 ? "Moderate" : "High";
            if (cases <= 10) return fatalityRate > 30 ? "High" : "Moderate-High";
            if (cases <= 20) return fatalityRate > 20 ? "Very High" : "High";
            return "Critical";
        }

        function generateSituationReport(verifiedData) {
            const risk_level = verifiedData.risk_level;
            const discrepancies = verifiedData.data_discrepancies;
            const forecast = verifiedData.forecast_data;
            
            const executive_summary = `
MARBURG VIRUS DISEASE OUTBREAK - ETHIOPIA
SITUATION REPORT
 
CONFIRMED CASES: ${verifiedData.confirmed_cases}
DEATHS: ${verifiedData.deaths}
CASE FATALITY RATE: ${verifiedData.case_fatality_rate}%
SUSPECTED CASES: ${verifiedData.suspected_cases}
TESTS CONDUCTED: ${verifiedData.tests_conducted}
CONTACTS MONITORED: ${verifiedData.contacts_monitored}
 
FORECAST SUMMARY (7-Day Projection):
- Predicted total cases by week end: ${forecast.total_forecast_cases}
- Predicted peak day for growth: ${forecast.peak_day}
 
DATA NOTES:
- Confirmed Case reports vary by source: ${discrepancies.case_range}
- Death reports vary by source: ${discrepancies.death_range}
- Using the highest confirmed counts for public health response planning
 
RISK LEVEL: ${risk_level}
 
PUBLIC HEALTH RESPONSE:
- Active case investigation and contact tracing initiated.
- Enhanced laboratory testing capacity established.
- Infection prevention controls escalated in healthcare facilities.
- Risk communication and community engagement intensified.
`;
            
            const recommendations = generateRecommendations(verifiedData);

            return {
                report_type: "Marburg Outbreak Situation Report - Ethiopia",
                generated_at: new Date().toLocaleString('en-US', { hour12: false, dateStyle: 'short', timeStyle: 'medium' }),
                executive_summary: executive_summary.trim(),
                recommendations: recommendations,
                status: verifiedData.confirmed_cases > 0 ? "Active Outbreak" : "Monitoring",
                alert_level: risk_level,
                key_metrics: verifiedData,
            };
        }

        function generateRecommendations(verifiedData) {
            const risk_level = verifiedData.risk_level;
            const cases = verifiedData.confirmed_cases;
            
            let recommendations = [
                "Maintain enhanced surveillance in affected regions.",
                "Continue laboratory testing and genomic sequencing.",
                "Coordinate data reporting between MOH, EPHI, and international partners."
            ];
            
            if (["Moderate", "Moderate-High"].includes(risk_level)) {
                recommendations.push(
                    "Activate national incident management system.",
                    "Enhance case finding and contact tracing resources.",
                    "Stockpile and distribute necessary PPE."
                );
            }
            
            if (["High", "Very High", "Critical"].includes(risk_level)) {
                recommendations.push(
                    "Activate emergency treatment centers.",
                    "Consider travel health notices for specific affected regions.",
                    "Mobilize national and international rapid response resources."
                );
            }
            
            if (cases > 10 || risk_level === "Critical") {
                recommendations.push(
                    "Consider declaring public health emergency.",
                    "Scale up risk communication nationwide.",
                    "Implement enhanced border screening if epidemiologically indicated."
                );
            }
            
            return recommendations;
        }


        // --- RENDERING FUNCTIONS ---

        function updateRiskAlertStyle(riskLevel) {
            const alertElement = document.getElementById('risk-level-alert');
            alertElement.className = 'p-6 rounded-xl shadow-2xl mb-12 text-center transition-all duration-500'; // Reset classes
            
            let bgColor = 'bg-gray-700';
            let borderColor = 'border-gray-500';
            let textColor = 'text-gray-200';
            let shadowColor = 'shadow-gray-800';

            switch (riskLevel) {
                case 'Low':
                    bgColor = 'bg-green-800';
                    borderColor = 'border-green-600';
                    shadowColor = 'shadow-green-900';
                    textColor = 'text-white';
                    break;
                case 'Moderate':
                case 'Moderate-High':
                    bgColor = 'bg-yellow-800';
                    borderColor = 'border-yellow-600';
                    shadowColor = 'shadow-yellow-900';
                    textColor = 'text-black';
                    break;
                case 'High':
                case 'Very High':
                    bgColor = 'bg-red-800';
                    borderColor = 'border-red-600';
                    shadowColor = 'shadow-red-900';
                    textColor = 'text-white';
                    break;
                case 'Critical':
                    bgColor = 'bg-black border-4 border-red-500 animate-pulse';
                    borderColor = 'border-red-500';
                    shadowColor = 'shadow-red-500/50';
                    textColor = 'text-red-300';
                    break;
            }

            alertElement.classList.add(bgColor, `border-2`, borderColor, shadowColor, textColor);
        }

        function renderDashboard(metrics) {
            document.getElementById('metric-cases').textContent = metrics.confirmed_cases;
            document.getElementById('metric-deaths').textContent = metrics.deaths;
            document.getElementById('metric-cfr').textContent = metrics.case_fatality_rate + '%';
            document.getElementById('metric-suspected').textContent = metrics.suspected_cases;
            document.getElementById('metric-contacts').textContent = metrics.contacts_monitored;
            document.getElementById('metric-tests').textContent = metrics.tests_conducted;
            document.getElementById('metric-tpr').textContent = metrics.test_positivity_rate + '%';
            document.getElementById('metric-sources').textContent = metrics.data_sources.join(' | ');
            
            document.getElementById('risk-level-value').textContent = metrics.risk_level.toUpperCase();
            document.getElementById('last-updated-display').textContent = 'Last Verified Data: ' + new Date(metrics.timestamp).toLocaleString();
            
            updateRiskAlertStyle(metrics.risk_level);
        }

        function renderReport(report) {
            document.getElementById('report-generated-at').textContent = report.generated_at;
            document.getElementById('report-summary').textContent = report.executive_summary;
            
            const recommendationsList = document.getElementById('report-recommendations');
            recommendationsList.innerHTML = ''; // Clear loading message

            report.recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.className = 'text-sm sm:text-base';
                li.textContent = rec;
                recommendationsList.appendChild(li);
            });
        }
        
        function renderTrends(verifiedData) {
            const { time_series, forecast_data } = verifiedData;
            
            // 1. Render Forecast Summary
            document.getElementById('forecast-cases').textContent = forecast_data.total_forecast_cases;
            document.getElementById('forecast-peak').textContent = forecast_data.peak_day;
            document.getElementById('forecast-narrative').textContent = forecast_data.narrative;
            
            // 2. Render Chart
            const chartData = {
                labels: time_series.labels.concat(forecast_data.forecast.map((_, i) => getDateNDaysFromNow(i + 1))),
                values: time_series.cases.concat(forecast_data.forecast),
                splitIndex: time_series.cases.length - 1
            };
            drawTimeLineChart('caseTrendChart', chartData);
        }

        /**
         * Draws a line chart on the canvas element using raw Canvas API.
         */
        function drawTimeLineChart(canvasId, chartData) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // Set canvas size (important for sharp rendering)
            const dpi = window.devicePixelRatio || 1;
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.width = canvas.offsetWidth * dpi;
            canvas.height = canvas.offsetHeight * dpi;
            ctx.scale(dpi, dpi);
            
            const { labels, values, splitIndex } = chartData;
            const width = canvas.offsetWidth;
            const height = canvas.offsetHeight;
            const padding = 30;
            const chartHeight = height - 2 * padding;
            const chartWidth = width - 2 * padding;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Determine max value for scaling
            const maxValue = Math.max(...values) * 1.1;

            // Plotting function
            const getX = (index) => padding + chartWidth * (index / (labels.length - 1));
            const getY = (value) => height - padding - chartHeight * (value / maxValue);

            // Draw Y-Axis (Value Labels)
            ctx.fillStyle = '#9ca3af';
            ctx.font = '10px Inter';
            for (let i = 0; i <= 5; i++) {
                const yValue = Math.round(maxValue * (i / 5));
                const yPos = getY(yValue);
                // Draw horizontal grid line
                ctx.strokeStyle = '#374151';
                ctx.beginPath();
                ctx.moveTo(padding, yPos);
                ctx.lineTo(width - padding, yPos);
                ctx.stroke();
                // Draw label
                ctx.fillText(yValue, padding - 25, yPos + 3);
            }
            
            // Draw X-Axis (Date Labels)
            labels.forEach((label, i) => {
                if (i % 3 === 0 || i === labels.length - 1) { // Only draw every 3rd label or the last one
                    const xPos = getX(i);
                    ctx.fillText(label, xPos - 20, height - padding + 15);
                }
            });


            // Draw Actual Trend Line (Historical)
            ctx.strokeStyle = '#ef4444'; // Red for confirmed cases
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(getX(0), getY(values[0]));
            for (let i = 1; i <= splitIndex; i++) {
                ctx.lineTo(getX(i), getY(values[i]));
                // Draw dots
                ctx.fillStyle = '#ef4444';
                ctx.beginPath();
                ctx.arc(getX(i), getY(values[i]), 3, 0, Math.PI * 2, true);
                ctx.fill();
            }
            ctx.stroke();

            // Draw Forecast Line (Dashed)
            ctx.strokeStyle = '#f59e0b'; // Yellow for forecast
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            // Start from the last historical point
            ctx.moveTo(getX(splitIndex), getY(values[splitIndex]));
            for (let i = splitIndex + 1; i < values.length; i++) {
                ctx.lineTo(getX(i), getY(values[i]));
                // Draw forecast dots
                ctx.fillStyle = '#f59e0b';
                ctx.beginPath();
                ctx.arc(getX(i), getY(values[i]), 3, 0, Math.PI * 2, true);
                ctx.fill();
            }
            ctx.stroke();
            ctx.setLineDash([]); // Reset line dash
        }


        // --- MAIN INITIALIZATION ---

        document.addEventListener('DOMContentLoaded', () => {
            try {
                // 1. Collect and Verify Data
                const rawData = generateRawData();
                const verifiedData = verifyData(rawData);
                const situationReport = generateSituationReport(verifiedData);

                // 2. Render UI
                renderDashboard(verifiedData);
                renderReport(situationReport);
                renderTrends(verifiedData); // Render the new Trends section

            } catch (error) {
                console.error("Failed to generate or render public health data:", error);
                document.getElementById('risk-level-value').textContent = "DATA ERROR";
                document.getElementById('last-updated-display').textContent = 'Last Verified Data: Failed to load report.';
                updateRiskAlertStyle("Critical");
            }
        });
        
        // Ensure chart redraws on window resize
        window.addEventListener('resize', () => {
            const rawData = generateRawData();
            const verifiedData = verifyData(rawData);
            renderTrends(verifiedData); 
        });
    </script>
</body>
</html>
